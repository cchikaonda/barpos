{% extends 'base.html' %}


{% block title %}

{% endblock title %}

{% block content %}

<div id="spinner-box" class="text-center mt-3"> 
    <div class="fa fa-spinner fa-spin fa-fw" role="status">
    </div>
    <span v-if="progress">Loading...</span>
</div>

<!-- /.card-header -->

<div id="page-content" class="card-body not-visible">
  

  <div class="card">
    <div class="card-header">
      <h3 class="card-title">Profit/Loss Report <strong>For {{report_period}}</strong> For {{item_cat}} </h3>
      <button id="download-button" class="btn btn-light" style="float: right;"> <i class="fa fa-download"></i> Download Report</button>
      <button id="download-excel-button" class="btn btn-light exportToExcel" style="float: right;"> <i class="fa fa-download"></i> Export Report to Excel</button>
    </div>
    
    <div class="row ml-3">
        <form action="{% url 'profit_report' %}" method="POST" class="row form-select ml-2 mr-2 mt-2 mb-2">
          {% csrf_token %}
              <div class="mt-2 ml-4">
                <label for="measure">Select Period</label>
                <div class="input-group">
                
                  <div class="input-group-prepend">
                    <span class="input-group-text"><i class="far fa-calendar-alt"></i></span>

                  </div>
                    <select class="form-control" id="example-select" name="report_period">
                      <i class="far fa-calendar-alt"> 
                        <option value="777"> All Days </option>
                      </i>
                        <option value="1" id="today_option" >Today</option>
                        <option value="2">Yesterday</option>
                        <option value="3">Last 7 Days</option>
                        <option value="4">Last 30 Days</option>
                        <option value="5">This Month</option>
                        <option value="6">Last Month</option>
                    </select>
                </div>
                <script type="text/javascript">
                    document.getElementById('report_period').value = "<?php echo $_GET['report_period'];?>";
                </script>
      
              </div>
              
              <div class="ml-4 mt-2 mb-4">
                <label for="date-rage">Category</label>
                  <div class="input-group-prepend " >
                    <select class="form-control" name="item_categories_option" >
                      <option value = "All Categories">All Categories</option>
                      {% for item_cat in item_categories %}
                        <option value="{{item_cat.category_name}}"> {{item_cat.category_name}}</option>
                      {%endfor%}
                    </select>
                    <button type="submit" name="button" class=" btn btn-info ml-2" style="width: 100px;">Select</button>
                    <a href="{% url 'profit_report' %}"> <button type="button" name="button" class=" btn btn-secondary ml-2" style="width: 100px;">Reset</button> </a>
                    <!--Custom Date Range-->
                  </div>
                  <script type="text/javascript">
                    document.getElementById('item_categories_option').value = "<?php echo $_GET['item_categories_option'];?>";
                  </script>
              </div>   
        </form>
          
        <div class="ml-4 mt-2 mb-4" >
          <label for="custom-rage text-right" >Custom Dates</label>
          <div>
            <a href="{% url 'custom_range_profit_report' %}"> <button type="button" name="button" class=" btn btn-success mt-2 mb-4">Custom Dates</button> </a>
          </div>   
        </div> 
    </div>
          
</div>


    <div id="report" class="dataTables_wrapper dt-bootstrap4 mb-4">
      <div class="row">
        <div class="col-sm-12 col-md-6">
        <div class="dataTables_length" id="example1_length">
          </div></div><div class="col-sm-12 col-md-6"><div id="example1_filter" class="dataTables_filter"></div></div></div><div class="row"><div class="col-sm-12">
    <table id="sales_report_table" class="table table-bordered table-striped dataTable dtr-inline js-dataTable-buttons" role="grid" aria-describedby="example1_info">
      <thead>
        <tr role="row">
          <th colspan="6" class="text-center">
            PROFIT/LOSS REPORT (Generated on {{report_time|date:"d/m/Y"}}, {{report_time|date:"H:i:s"}})
          </th>
        </tr>
      <tr role="row">
        
        <th class="sorting">Item Name</th>
        <th class="sorting text-center">Quantity</th>
        <th class="text-right">Cost</th>
        <th class="sorting text-right">Revenue</th>
        <th class="text-right">Profit</th>
        
      </thead>
      <tbody>
      {% for total_item in total_item_sold %}
      <tr role="row" class="odd">
        <td>{{total_item.item_name}}</td>
        <td class="text-center">{{total_item.total_quantity}}</td>
        <td class="text-right">{{total_item.cost_of_items}}</td>
        <td class="text-right">{{total_item.sales_total}}</td>
        {% if total_item.profit.amount > 0.0 %}
        <td class="text-right">
            <span >
                {{total_item.profit}} <i class="fas fa-arrow-up"></i>
            </span>
        </td>
        {% else %}
        <td class="text-right">
            <span >
                {{total_item.profit}}  <i class="fas fa-arrow-down"></i>
            </span>
        </td>
        {% endif %}
      </tr>
      {% endfor %}
      {% for expense in summery_expenses %}
      <tr class="text-bold">
        <td>{{expense.category__category_name}} 
          <a  class="btn btn-sm" data-toggle="modal" data-target="#expense_details{{expense.category__id}}">
            <i class="fas fa-eye"> </i>
          </a>


                        <!--View Expenses Modal-->
              <div class="modal fade" id="expense_details{{expense.category__id}}" >
                <div class="modal-dialog modal-dialog-centered modal-xl">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h4 class="modal-title">{{expense.category__category_name}} Expense(s) </h4> 
                      <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Ã—</span>
                      </button>
                    </div>
                    <div class="modal-body">  
                        <div class="form-group">
                          <div class="mb-4">
                            <table class="table table-striped" >
                              <thead>
                                <tr>
                                  <th>Expense Name</th>
                                  <th>Description</th>
                                  <th class="text-center">Date Created</th>
                                  <th class="text-right">Payment Mode</th>
                                  <th class="text-right">Amount</th>
                                </tr>
                              </thead>
                              <tbody>
                              {% for expense_list in expense_list %} 
                                  {% for expense in summery_expenses %}
                                  {% endfor %}
                                  {% if expense_list.category__id == expense.category__id %}
                                  <tr>
                                    <td>{{expense_list.expense_name}}</td>
                                    <td>{{expense_list.expense_description}}</td>
                                    <td class="text-center">{{expense_list.created_at}}</td>
                                    <td class="text-center">{{expense_list.payment_mode}}</td>
                                    <td class="text-right">{{expense_list.amount}}</td>
                                  {% endif %}
                                 
                              {% endfor %}
                                <tr>
                                    <td  colspan="4" class="font-w700 text-uppercase text-right bg-body-light">Total</td>
                                    <td class="font-w700 text-right bg-body-dark" >{{expense.total_expense}}</td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </div>
                    <div class="modal-footer justify-content-between">
                      <button type="button" class="btn btn-lg btn-default" data-dismiss="modal">Close</button>
                    </div>
                  </div>
                
                  <!-- /.modal-content -->
                </div>
              </div>
              <!--End View Bill Modal-->

        </td>
        <td class="text-center bg-secondary"></td>
        <td class="text-right">{{expense.total_expense}}</td>
        <td class="text-right">MWK 0.00</td>
        <td class="text-right">
            <span >
                -{{expense.total_expense}} <i class="fas fa-arrow-down"></i>
            </span>
        </td>
      </tr>
      {% endfor %}
      <tr class="text-bold">
        
        <td class="text-right " >
          TOTAL
        </td >
       
        <td class="text-center">
          {{sum_ordered_items_count}}
        </td>
        <td class="text-right" >
            {{total_value_items_ordered}}
        </td>
        <td class="text-right">
          {{total_cost_items_ordered}}
        </td>
        {% if gross_profit.amount > 0.0 %}
        <td class="text-right">
            <span class="text-success">
                <i class="fas fa-arrow-up"></i> {{gross_profit}}
            </span>
        </td>
        {% else %}
        <td class="text-right">
            <span class="text-danger">
                <i class="fas fa-arrow-down"></i> {{gross_profit}}
            </span>
        </td>
        {% endif %}
      </tr>
      </tbody>
      <tfoot>
      </tfoot>
    </table>
  </div>
  
  <div><br></div>
</div>
    </div>
  <!-- /.card-body -->
</div>



{% endblock content %}
